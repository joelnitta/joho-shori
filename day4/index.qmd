---
format:
  revealjs:
    incremental: false
    css: ../styles.css
execute: 
  echo: true
---

# 第4回：データの整理（１）

<https://data-science-chiba-2024.github.io/day4/>


## データの整理（Data Wrangling）

- データが手に入る時、まだ解析に使いえない状態が多い

- データの整理（「wrangling」）は**解析に使えるように整えるプロセス**
  - 元々はカウボーイが**牛を扱う技術**から来る

---

![Getty Images](https://media.istockphoto.com/id/172342607/photo/cattle-drive.jpg?s=612x612&w=0&k=20&c=Fz--vTqe2gMWKxbHvgdLCgfUveH_Y3-k0js5H1m9Snc=)

---

![Image by Allison Horst](https://datasciencecampus.github.io/DSCA_data_wrangling_with_r/slides/images/data_cowboy.png){fig-alt="data wrangling monsters"}

## 準備

- `students_analysis`プロジェクトを再度開きます。

. . .

- 新しいコマンドの勉強に進む前に、今までのスクリプトを少し変えたいと思います。

- 先のスライドで説明しましたように、データ解析をする前に**データの整理が必要**なケースが多いです。

- 今回の`students.csv`に入っているデータもそうです。

---

- なので、`students.csv`から読み込む時はとりあえず`students_raw`という名前にしましょう。`raw`はこれが**生データ**（読み込んだデータのまま、何もまだ手をつけていない状態）を示す：

```{r}
#| filename: students.R
#| eval: false
library(tidyverse)

# Load raw data
students_raw <- read_csv("data/students.csv")
```

```{r}
#| echo: false

library(tidyverse)

students_raw <- read_csv("../data/students.csv")
```

## データ整理の関数

これから学ぶ関数の共通点：

- データフレームをインプットとし、データフレームを返す
- 最初の引数がインプットのデータフレーム
- 他の引数は詳細（行の名前に引用符を使わない）

`関数(データフレーム, 他の設定)` ➞ `データフレーム`

## データの整理：列名を整える

- データフレームの列名は任意ですが、使いやすい名前は以下の特徴があります：
  - 打ちやすい
  - 覚えやすい

- `` `Full Name` ``は打ちづらい。`` ` `` もありますし、スペースも入っています。

- **おすすめ**：小文字だけ、スペースの代わりに`_`を使う

## `rename()`で列名を変える

- `rename()`は列名を変える関数です。
  - `新しいい名前 = 前の名前`と指定します

```{r}
#| attr-output: "style='font-size: 0.3em'"
rename(students_raw, full_name = `Full Name`)
``` 

---

![](../images/rename_annotated.png)

---

```{r}
#| attr-output: "style='font-size: 0.3em'"
rename(students_raw, full_name = `Full Name`)
``` 

- 注意：このようにしただけでは、元のデータは**変わっていません**。`<-`を使わない限り、関数の結果は保存されません。

## チャレンジ ①

`` `Student ID` ``という列を使いやすい列名に変えてください

## `rename()`で列名を変える

- 複数の列名を変える際は、コンマで区切って書きます：

```{r}
#| attr-output: "style='font-size: 0.3em'"
rename(
  students_raw,
  full_name = `Full Name`,
  student_id = `Student ID`
  )
``` 

## 一気に列名を扱いやすくする

- 名前を一個ずつ全部変更するのがめんどくさいですね。

- `clean_names()`という関数が列名を一気にきれいにしてくれます。
  - この関数は`tidyverse`に含まれていないパッケージ、`janitor`に入っているので、まずは`janitor`をロードする必要があります。

---

```{r}
#| attr-output: "style='font-size: 0.3em'"
library(janitor)
clean_names(students_raw)
``` 

---

これを`students_renamed`として保存しましょう：

```{r}
students_renamed <- clean_names(students_raw)
``` 

## `mutate()`で列の中身を変える

- 「mutate」は「変化させる」という意味です。

- `age`は数字のはずですが、文字として読み込まれてしまいました。直しましょう：

```{r}
#| attr-output: "style='font-size: 0.3em'"
mutate(students_renamed, age = parse_number(age))
```

---

- `parse_number()`は文字列を数字に変換する関数です

- 注意が出ました。これは、データの中にうまく数字に変換できなかった値があったことを意味しています。

- 本当は直した方がいいですが、ちょっと上級な話になりますので飛ばします。知りたい方は教科書を読んでいただくか、講義の後に聞いてください。

---

## きれいなデータを保存する

- これでデータが（ほとんど）整いましたので、`students`として保存します：

::: {.medsmall}

```{r}
#| filename: students.R
#| eval: false
library(tidyverse)
library(janitor)

# Load raw data
students_raw <- read_csv("data/students.csv")

# Clean names
students_renamed <- clean_names(students_raw)

# Convert age to numeric
students <- mutate(students_renamed, age = parse_number(age))
```

:::

```{r}
#| echo: false

# Clean names
students_renamed <- clean_names(students_raw)

# Convert age to numeric
students <- mutate(students_renamed, age = parse_number(age))
```

## `arrange()`で行を並び替える

- `arrange()`は行の順を並び替える関数です。
  - 食事プラン（「`meal_plan`」）の順に並び替えましょう。

---

```{r}
#| attr-output: "style='font-size: 0.3em'"
arrange(students, meal_plan)
``` 

---

![](../images/arrange_annotated.png){height=300px}

## `arrange()`で行を並び替える

- デフォルト設定では、`arrange()`は小さい方から大きい方へと並び替えます。

- 逆の順にするには、列名を`desc()`の中に書きます：

```{r}
#| attr-output: "style='font-size: 0.3em'"
arrange(students, desc(meal_plan))
``` 

## チャレンジ ②

学生の**名前の順**に並び替えてください

## `filter()`で行を絞り込む

- 生データが必要以上に多い場合がよくある（特に、「ビッグデータ」を扱っているとき）

- `filter()`で条件を定めて、その行だけに絞り込む

---

```{r}
#| attr-output: "style='font-size: 0.3em'"
filter(students, student_id < 4)
```

- 行の数が変わったことを確認できますか？

## データの比較

データの比較を行う主な記号：

- `>` より大きい
- `<` より小さい
- `==` イコール （`=`ではない！）
- `|` あるいは
- `&` そして（複数条件の指定）

比較の記号のアウトプットは**論理ベクトル**

---

```{r}
11 > 10
```

---

```{r}
c(1, 2, 3, 4, 5, 6) > 4
```

---

```{r}
11 == 11
```

---

```{r}
#| error: TRUE
11 = 11
```

## チャレンジ ③

`students`の中から食事プランが`"Lunch only"`になっている学生に絞ってから、名前をZからAの順で並び替えてください。

## パイプについて

- チャレンジ ③では、条件で絞ったデータ一を一旦保存してから、次のステップ（列の並び替え）をしました。

```{r}
#| attr-output: "style='font-size: 0.3em'"
students_lunch <- filter(students, meal_plan == "Lunch only")
arrange(students_lunch, desc(full_name))
``` 

## パイプについて

- これは解析が短い場合は大丈夫かもしれませんが、長くなると、**大変です**。

- **パイプ**というものがこの問題を解決します。

## パイプの使い方

- まずはパイプ（`|>`）の基本的な使い方を覚えましょう。
  - 以前は`%>%`と書きましたが、最近のRでは`|>`と書きます

- `arrange(データ, 列名)`というような書き方をしてきたが、パイプを使うとこのように書きます：

`データ |> arrange(列名)`

---

- つまり、`|>` は**左の方の物を右の方へ渡す**機能があります

使ってみましょう：

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |> arrange(meal_plan)
``` 

---

- 繰り返しになりますが、

`students |> arrange(meal_plan)`

と

`arrange(students, meal_plan)`

は**同じです**

---

- パイプの便利なところは、**途中結果を保存することなく**解析のステップを次から次へと進むことができます：

::: {.medsmall}

```{r}
students |> filter(meal_plan == "Lunch only") |> arrange(full_name)
``` 

:::

---

- Rは改行があっても構いませんので、改行入れいるともっと読みやすくなります：

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |>
  filter(meal_plan == "Lunch only") |>
  arrange(full_name)
``` 

---

```{r}
#| eval: false
students |>
  filter(meal_plan == "Lunch only") |>
  arrange(full_name)
``` 

`|>` を見たら、「それから」と読みます：

*`students`から始めて、**それから**食事プランが"Lunch only"となっている学生に絞って、**それから**学生の名前順に並び替える*

---

- これからは基本的にパイプを使ってコードを書きます
  - 最初はおかしいように見えるかもしれませんが、すぐに慣れるでしょう

## 欠測データについて

- `age`には`NA`という値が入っています。

- `NA`は英語で「Not Applicable」(「該当しない」)という意味です。
  - つまり、そのデータは該当しないか、あるいは欠損となっている、という意味です。
  - `age`の場合は何らかな理由でその人の歳が分からない、ということです。
  - （一つはうまく数字への変換が出来なかったためですが、もう一つは元々そうなっていました）

## 欠測データを省く方法

- 欠測データがデータフレームに入っていると、エラーの元になることが多いです。
  - 解析をする前にそれを省く必要がよくあります
  - `is.na()`関数はその値が`NA`になっているかどうかを教えてくれる。

- 例えば：

```{r}
is.na(c(1, 2, NA, 3))
```

---

では、使ってみましょう：

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |>
  filter(is.na(age))
```

あらら。これはちょっとまずいですね。欠測データ**だけ**に絞られてしまいした。

私たちが欲しいのは、その**逆**です。

---

- `!`は論理ベクトルを**反対**にします。
  - つまり、`TRUE`を`FALSE`にして、`FALSE`を`TRUE`にします。「否」と読めば良い。

```{r}
!is.na(c(1, 2, NA, 3))
```

---

- `!`で`NA`**ではない**データだけに絞りましょう：

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |>
  filter(!is.na(age))
```

## チャレンジ ④

`students`から`age`が`NA`になっている行を外してから、`favorite_food`の順で並び替えてください。（パイプを使ってください）

## まとめ

- データを読み込んでから、整える必要があります
- `rename()`は列の名前を変える
- `arrange()`は行を並び替える
- `mutate()`は行の中身を変える
- `filter()`は行を絞る
- `|>`（パイプ）を使うと、複数の動作を連続で行える

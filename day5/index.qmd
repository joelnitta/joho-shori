---
format:
  revealjs:
    incremental: false
    css: ../styles.css
execute: 
  echo: true
---

# 第5回：データの整理（2）

<https://data-science-chiba-2024.github.io/day5/>

## クイズ

:::: {.columns}

::: {.column width="50%"}
![](../images/joho2024-qr-code.png)
:::

::: {.column width="50%"}
**注意：** 質問は複数選択です。**すべて**の正しい答えを選んでください。

クイズの間、スマートフォンを利用してクイズに答えてください。他の行為（スライドを見ることや、RStudioの操作など）は**禁止**です。
:::

::::

または、[gosocrative.com](https://gosocrative.com) で joho2024を入力

## おさらい

- 前回は以下のデータ処理に必要な関数を学びました：
  - `rename()`は列の名前を変更する。
  - `mutate()`は列の中身を変える。
  - `arrange()`は行を並び替える。
  - `filter()`は行を絞り込む。

## 準備

- 前回休んでいた方は、[Moodle](<https://moodle.gs.chiba-u.jp/moodle/mod/resource/view.php?id=1295207>)から第5回にある`students_analysis.zip`をダウンロードして、デスクトップで開いてください。
  - 後ほどMoodleから別のファイルをダウンロードする必要があるので、**今のうちにMoodleにログインしてください（全員）**

- デスクトップにある`students_analysis`フォルダーの中に入っている`students_analysis.Rproj`をダブルクリックすることによって、プロジェクトを開いてください。

---

![](../images/download-project-1.png)

---

![](../images/download-project-2_annotated.png)

---

![](../images/download-project-3_annotated.png)

---

![](../images/download-project-5_annotated.png)

---

![](../images/download-project-6.png)

---

![](../images/download-project-7_annotated.png)

---

- `students.R`のコードを実行することによってデータを読み込んで、整えてください。

::: {.medsmall}

```{r}
#| filename: students.R
#| eval: false
library(tidyverse)
library(janitor)

# Load raw data
students_raw <- read_csv("data/students.csv")

# Rename columns
students_renamed <- clean_names(students_raw)

# Convert age to numeric
students <- mutate(students_renamed, age = parse_number(age))
```

```{r}
#| echo: false
library(tidyverse)
library(janitor)

# Load raw data
students_raw <- read_csv("../data/students.csv")

# Rename columns
students_renamed <- clean_names(students_raw)

# Convert age to numeric
students <- mutate(students_renamed, age = parse_number(age))
```

:::

## チャレンジ ①

早速チャレンジです。

`students`の中から食事プランが`"Lunch only"`になっている学生に絞り込んでから、名前をZからAの順で並び替えてください。

## パイプについて

- チャレンジ ①では、条件で絞ったデータを一旦保存してから、次のステップ（列の並び替え）を行いました。

```{r}
#| attr-output: "style='font-size: 0.3em'"
#| eval: false
#| include: false
students_lunch <- filter(students, meal_plan == "Lunch only")
arrange(students_lunch, desc(full_name))
``` 

## パイプについて

- これは解析が短い場合は大丈夫かもしれませんが、長くなると**大変です**。

- **パイプ**というものがこの問題を解決します。

## パイプの使い方

- まずはパイプ（`|>`）の基本的な使い方を覚えましょう。
  - 以前は`%>%`と書きましたが、最近のRでは`|>`と書きます。

- `arrange(データ, 列名)`というような書き方をしてきましたが、パイプを使うとこのように書きます：

`データ |> arrange(列名)`

---

- つまり、`|>`は**左側のものを右側へ渡す**機能があります。

使ってみましょう。

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |> arrange(meal_plan)
``` 

---

- 繰り返しになりますが、

`students |> arrange(meal_plan)`

と

`arrange(students, meal_plan)`

は**同じです**。

---

- パイプの便利な点は、**途中結果を保存することなく**解析のステップを次から次へと進めることができる点です。

::: {.medsmall}

```{r}
students |> filter(meal_plan == "Lunch only") |> arrange(full_name)
``` 

:::

---

- Rは改行があっても構いませんので、改行を入れるともっと読みやすくなります。

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |>
  filter(meal_plan == "Lunch only") |>
  arrange(full_name)
``` 

---

```{r}
#| eval: false
students |>
  filter(meal_plan == "Lunch only") |>
  arrange(full_name)
``` 

`|>` を見たら、「それから」と読みます：

*`students`から始めて、**それから**食事プランが"Lunch only"となっている学生に絞り込んで、**それから**学生の名前順に並び替える*

---

- これからは基本的にパイプを使ってコードを書きます。
  - 最初は違和感があるかもしれませんが、すぐに慣れるでしょう。

## チャレンジ ②

パイプを使って`students`の中から`student_id`が2より大きいな行だけに絞ってから、`favourite_food`の順で並び替えてください。

## 欠測データについて

- `age`には`NA`という値が入っています。

- `NA`は英語で「Not Applicable」（「該当しない」）という意味です。
  - つまり、そのデータは該当しないか、あるいは欠損しているという意味です。
  - `age`の場合は何らかの理由でその人の年齢が分からないということです。
  - （一つはうまく数字への変換ができなかったためですが、もう一つは元々そうなっていました）

## 欠測データを省く方法

- 欠測データがデータフレームに含まれていると、エラーの原因になることが多いです。
  - 解析を行う前にそれを除外する必要があります。
  - `is.na()`関数はその値が`NA`であるかどうかを教えてくれます。

- 例えば：

```{r}
is.na(c(1, 2, NA, 3))
```

---

では、使ってみましょう。

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |>
  filter(is.na(age))
```

あらら。これはちょっとまずいですね。欠測データ**だけ**に絞られてしまいました。

私たちが欲しいのは、その**逆**です。

---

- `!`は論理ベクトルを**反転**させます。
  - つまり、`TRUE`を`FALSE`に、`FALSE`を`TRUE`にします。「否」と読めば良いです。

```{r}
!is.na(c(1, 2, NA, 3))
```

---

- `!`を使って`NA`**ではない**データだけに絞り込みましょう。

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |>
  filter(!is.na(age))
```

## チャレンジ ③

`students`から`age`が`NA`になっている行を除外してから、`favorite_food`の順で並び替えてください。（パイプを使ってください）

## 列を選ぶ

- 特にデータが大きい場合は解析に必要ではない列がある場合があります。

- 必要な列だけに絞ることによって解析がやりやすくなります。

---

- 列を選ぶ関数は`select()`です。例えば、`student_id`、`full_name`、`meal_plan`を選択します：

```{r}
#| attr-output: "style='font-size: 0.3em'"
students |>
  select(student_id, full_name, meal_plan)
```

## 列や行を扱う関数

- 前回は以下のデータ処理に必要な関数を学びました：
  - `rename()`は列の名前を変更する。
  - `mutate()`は列の中身を変える。
  - `select()`は列を選択する。
  - `arrange()`は行を並び替える。
  - `filter()`は行を絞り込む。

## 新しいプロジェクト：`gapminder`

- これから教える関数はもっと大きなデータに使うので、**新しいプロジェクト**を作ります。

- このプロジェクトでは`gapminder`というデータセットを使います。1952年〜2007まで、各国の経済的なデータが入っています（第4回の宿題にも使っています。

## `gapminder`プロジェクトの作成

1. デスクトップに`gapminder_analysis`というプロジェクトを作って、そのプロジェクトを開いてください。
  - プロジェクトの作り方については、[第3回のスライド](https://joelnitta.github.io/joho-shori/day3/#/%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9)を参照してください。

## `gapminder`プロジェクトの作成

2. データをMoodleからダウンロードして、`gapminder_analysis`の中においてください：

<https://moodle.gs.chiba-u.jp/moodle/mod/resource/view.php?id=1295476>

## `gapminder`プロジェクトの作成

3. 新しいプロジェクトの中に、`gapminder.R`というRファイルを作成して、`gapminder`というデータセットをロードするコードを書きます：

```{r}
#| filename: gapminder.R
#| eval: false
library(tidyverse)
library(janitor)

# Load raw data
gapminder_raw <- read_csv("gapminder.csv")

# Fix column names
gapminder <- clean_names(gapminder_raw)
```

```{r}
#| echo: false
library(tidyverse)
library(janitor)
gapminder_raw <- read_csv(here::here("data/gapminder_data.csv"))
gapminder <- clean_names(gapminder_raw)
```

## データの集計

- 今までの関数はデータフレームの値を個別に扱いました（主に**列**か**行**を扱う関数を使ってきました）。

- でも、データフレームに入っている値の平均や合計を**計算したい場合**は、それでは足りません。

## データの合計を`count()`で数える

- データの全貌を捉えるためにまず便利なのは、数えることです。

- 例えば、`gapminder`に幾つの国が入っているでしょうか？
  - **注意**：`count()`のような集約の関数の結果は、入力の結果と大幅に形が違います！

---

```{r}
gapminder |> count(country)
```

## データの平均などを計算するためには`summarize()`を使う

- `summarize()`（「集計する」）の使い方は`mutate()`と似ています。

- `summarize(データ, 新しい列名 = コマンド)`
  - コマンドには、新しい列の作り方を指定します

---

- 例えば、全国の寿命の平均を計算しましょう：

```{r}
gapminder |>
  summarize(mean_life_exp = mean(life_exp))
```

- `mean()`は平均を計算する関数です。
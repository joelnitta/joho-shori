---
format:
  revealjs:
    incremental: false
    css: ../styles.css
execute: 
  echo: true
---

# 第7回：データの可視化（2）

<https://data-science-chiba-2024.github.io/day7/>

## 連絡事項

- オンデマンド回の課題と倫理教育e-learningの締め切りは **11月21日（木）** です。
  - **早めの提出を心がけてください。**

## クイズ

:::: {.columns}

::: {.column width="50%"}
![](../images/joho2024-qr-code.png)
:::

::: {.column width="50%"}
**注意：** 質問は複数選択です。**すべて**の正しい答えを選んでください。

クイズ中は質問に回答してください。他の行為（スライドの閲覧やRStudioの操作など）は**禁止**です。
:::

::::

## 今日のアウトライン

- 前回のおさらい
- データの可視化（2）
  - 図にモデルを加える
  - 図のラベルを整える
  - 図の色を整える
- フリータイム（残っている課題に使ってください）

## 前回のおさらい

```{r}
#| echo: false
library(tidyverse)
library(palmerpenguins)
library(ggrepel)
library(showtext)
library(ggthemes)
```

- ggplot2のggは「**g**rammar of **g**raphics」（「図の文法」）です
- 図の文法
  - 標本方法（aesthetics）
  - 形状（geometry）

## パッケージの準備

- `penguins_analysis`を開いて、その中の`penguins.R`を開きます

- パッケージとデータをロードします：

---

::: {.medsmall}

```{r}
#| filename: penguins.R
#| attr-output: "style='font-size: 0.4em'"
library(tidyverse)
library(palmerpenguins)

penguins
```

:::

---

![](https://allisonhorst.github.io/palmerpenguins/reference/figures/lter_penguins.png)

## 前回の最後に書いた図

::: {.medsmall}
```{r}
#| output-location: column
ggplot(
  penguins,
  aes(
    x = flipper_length_mm,
    y = body_mass_g,
    color = species
  )
) +
  geom_point()
```
:::


## モデルとは、データを予測する数式

- 次に、**データの関係を表すモデル**を加えたいと思います。
- **線形モデル**（linear model）は、二つの変数を関係を一直線で表すモデルです。
- $y=ax+b$ という数式で表します


---

```{r}
#| echo: false
#| fig-asp: 1

# Add a Japanese font
font_add_google("Noto Sans JP", "noto")
showtext_auto()

# Create sample data
set.seed(123)
x <- seq(1, 10, by = 0.5)
a <- 2  # slope
b <- 3  # intercept
y <- a * x + b + rnorm(length(x), sd = 2)  # Add some noise to the data
data <- data.frame(x = x, y = y)

# Label data for ggrepel
label_data <- data.frame(
  x = c(0, 3),  # X position for y-intercept and slope
  y = c(b, a * 3 + b),  # Y position for y-intercept and slope
  label = c("y切片 (b = 3)", "傾き (a = 2)")  # Labels
)

# Generate the plot
ggplot(data, aes(x = x, y = y)) +
  geom_point(color = "blue", size = 2) +  # Scatter plot of points
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey20") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey20") +
  labs(
    title = "y = ax + b のグラフ",
    x = "X軸",
    y = "Y軸"
  ) +
  scale_y_continuous(limits = c(0, NA)) +
  theme_gray(base_size = 24, base_family = "noto")
```

---

```{r}
#| echo: false
#| fig-asp: 1

# Generate the plot
ggplot(data, aes(x = x, y = y)) +
  geom_point(color = "blue", size = 2) +  # Scatter plot of points
  geom_abline(slope = a, intercept = b, color = "red") +  # Line for y = ax + b
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey20") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey20") +
  # Intercept annotation
  annotate("point", x = 0, y = b, color = "purple", size = 4) + 
  geom_label_repel(
    data = label_data[1,],
    aes(x = x, y = y, label = label),
    color = c("purple"),
    size = 10,
    fontface = "bold",
    label.padding = 0.5,
    ylim = 2.5, xlim = 1
  ) +
  # Slope annotation
  annotate("segment", x = 2.5, xend = 3.5, y = a * 2.5 + b, yend = a * 3.5 + b, 
           arrow = arrow(length = unit(0.2, "cm")), color = "darkgreen", size = 1.5) +
  geom_label_repel(
    data = label_data[2,],
    aes(x = x, y = y, label = label),
    color = c("dark green"),
    size = 10,
    fontface = "bold",
    label.padding = 0.5,
    ylim = 10, xlim = 5
  ) +
  annotate("text", x = 6, y = max(y) - 2, label = "y = 2x + 3", 
           color = "red", size = 10, hjust = 0) +  # Annotate equation
  labs(
    title = "y = ax + b のグラフ",
    x = "X軸",
    y = "Y軸"
  ) +
  scale_y_continuous(limits = c(0, NA)) +
  theme_gray(base_size = 24, base_family = "noto")
```

---

### geom_smooth()で線形モデルを加える

::: {.medsmall}
```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    color = species
  )
) +
  geom_smooth(method = "lm")
```

:::

---

:::: {.columns}

::: {.column width="50%"}
- **でも、今のモデルは種ごとになっている**（それぞれに違う傾きと切片がある）

- 目的のグラフでは一つの線しかない（**全部の種が一つのモデルに入っている**）
:::

::: {.column width="50%"}
![](https://r4ds.hadley.nz/data-visualize_files/figure-html/unnamed-chunk-7-1.png)
:::

::::

---

### `color`を外すと、全部の種が同じモデルに含まれる

::: {.medsmall}
```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g
  )
) +
  geom_smooth(method = "lm")
```

:::

---

### geom_point()で元のデータを点で表す

::: {.medsmall}
```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g
  )
) +
  geom_smooth(method = "lm") +
  geom_point()
```

:::

---

[そうか、色をまた戻さないと・・]{.large}

---

::: {.medsmall}
```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    color = species
  )
) +
  geom_smooth(method = "lm") +
  geom_point()
```

:::

---

[しまった、また種別の線になった。<br>どうしよう？]{.large}

---

### `geom_()`の中に`mapping`を入れられます

::: {.medsmall}
```{r}
#| output-location: column
ggplot(data = penguins) +
  geom_point(
    mapping = aes(
      x = flipper_length_mm,
      y = body_mass_g,
      color = species
    )
  )
```
:::

---

[`aes()`を`geom_()`の中に入れると、それぞれの`geom_`に**異なるデータの表現方法**を指定することができます！]{.medlarge}

---

### `geom_()`の中に`mapping`を入れられます

::: {.medsmall}
```{r}
#| output-location: column
ggplot(data = penguins) +
  geom_point(
    mapping = aes(
      x = flipper_length_mm,
      y = body_mass_g,
      color = species
    )
  ) +
  geom_smooth(
    mapping = aes(
      x = flipper_length_mm,
      y = body_mass_g
    ),
    method = "lm"
  )
```
:::

---

[でも、一々書くとめんどくさい・・]{.medlarge}

---

- `ggplot()`の中に`aes()`を入れると、それが**全部**の`geom_()`に適応される

- 共通に持っているデータの表現方法だけを`ggplot()`に書けばいい！

---

共通の表現方法を`ggplot()`に、他はそれぞれの`geom_()`に書きます：

::: {.medsmall}
```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g)
  ) +
  geom_point(aes(color = species)) +
  geom_smooth(method = "lm")
```
:::

## チャレンジ

種を点の形で表してください

## レーヤーについて

- `+`で加えるコードを**「レーヤー」**（layer）と呼びます
- レーヤーには**順番があります**：下から上まで塗って行きます

---

![](https://r.qcbs.ca/workshop03/book-en/images/gglayers.png)

## チャレンジ

`geom_point()`のレーヤーと`geom_smooth`のレーヤーの順番を変えてみてください。

図がどう変わりましたか？

## `labs`レーヤーで図のラベルを整える

- 発表する際、図は誰にでも分かりやすくする必要があります
- あなた（図を作った人）は`flipper_length_mm`が何を意味しているのか分かるでしょうが、見ている人にとっては分かりにくいです。

## `labs`レーヤーで図のラベルを整える

- つまり、名前の作り方は使っている人うによって違う：
  - `flipper_length_mm`：コードを書いている人
  - `Flipper length (mm)`：図を見ている人
- **解決策**：元のデータの変数名（列名）を変えたくないので、**読みやすいラベルを図の作成の段階で指定します**

---

::: {.medsmall}

### `labs`レーヤーでラベルを指定する

```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    shape = species)
  ) +
  geom_point(aes(color = species)) +
  geom_smooth(method = "lm") +
  labs(
    x = "Flipper length (mm)"
  )
```

:::

## チャレンジ

縦軸のラベルを読みやすくしてください。

---

### ラベルを整えた図

::: {.medsmall}

```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    shape = species)
  ) +
  geom_point(aes(color = species)) +
  geom_smooth(method = "lm") +
  labs(
    title = "Body mass and flipper length",
    subtitle = "Dimensions for Adelie, Chinstrap, and Gentoo Penguins",
    x = "Flipper length (mm)", y = "Body mass (g)",
    color = "Species", shape = "Species"
  )
```

:::

## 色を整える

- 文章だけではなく、色もどなたにでも分かりやすくする必要があります。
- 世界人口の約**4〜5％**が色覚異常を持つ（男性8％、女性0.5％）
- ggplot2のデフォルトの色では色覚異常の方には識別しづらい
- 色覚異常を考慮した色の配置を使う必要があります

## `ggthemes`の色を使う

- `ggthemes`というパッケージに色覚異常を考慮した色が含まれています
- `tidyverse`には入っていないので、インストールが必要です

```{r}
#| eval: false
install.packages("ggthemes")

library(ggthemes)
```

---

### `ggthemes`の色を使う

::: {.medsmall}

```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    shape = species)
  ) +
  geom_point(aes(color = species)) +
  geom_smooth(method = "lm") +
  labs(
    title = "Body mass and flipper length",
    subtitle = "Dimensions for Adelie, Chinstrap, and Gentoo Penguins",
    x = "Flipper length (mm)", y = "Body mass (g)",
    color = "Species", shape = "Species"
  ) +
  scale_color_colorblind()
```

:::

# できました！

## 文字化けを防ぐ方法

- ggplot2のデフォルトのフォントでは、日本語が文字化けしてしまいます

---

::: {.medsmall}

```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    shape = species)
  ) +
  geom_point(aes(color = species)) +
  geom_smooth(method = "lm") +
  labs(
    title = "ペンギンの体重および翼の長さ"
  ) +
  scale_color_colorblind()
```

:::

## `showtext`で日本語の表示が可能なフォントを使う

- `showtext`というパッケージは他のフォントの使用を可能にします
- `tidyverse`には入っていないので、インストールが必要です

```{r}
#| eval: false
install.packages("showtext")

library(showtext)
```

## `showtext`で日本語の表示が可能なフォントを使う

- `ggplot()`の前にフォントの設定をします：

```{r}
#| eval: false

# Add a Japanese font
font_add_google("Noto Sans JP", "noto")
showtext_auto()
```

---

### `theme_()`でフォントを指定する

::: {.medsmall}

```{r}
#| output-location: column
font_add_google("Noto Sans JP", "noto")
showtext_auto()

ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    shape = species)
  ) +
  geom_point(aes(color = species)) +
  geom_smooth(method = "lm") +
  labs(
    title = "ペンギンの体重および翼の長さ"
  ) +
  scale_color_colorblind() +
  theme_grey(base_family = "noto")
```

:::

## `theme_()`で図の全体の色やフォントなどを整える

::: {.medsmall}

```{r}
#| output-location: column
ggplot(
  data = penguins,
  mapping = aes(
    x = flipper_length_mm,
    y = body_mass_g,
    shape = species)
  ) +
  geom_point(aes(color = species)) +
  geom_smooth(method = "lm") +
  labs(
    title = "Body mass and flipper length",
    subtitle = "Dimensions for Adelie, Chinstrap, and Gentoo Penguins",
    x = "Flipper length (mm)", y = "Body mass (g)",
    color = "Species", shape = "Species"
  ) +
  scale_color_colorblind() +
  theme_minimal()
```

:::

## 他の`theme_()`

ggplot2にはこのような`theme_()`があります：

- `theme_grey()` （デフォルト）
- `theme_bw()`
- `theme_linedraw()`
- `theme_light()`
- `theme_dark()`
- `theme_minimal()`
- `theme_classic()`
- `theme_void()`

# チャレンジ

他のテーマを試してみてください。どちらが好きですか？

## `ggthemes`パッケージにはもっとあります

<iframe src="https://yutannihilation.github.io/allYourFigureAreBelongToUs/ggthemes/" 
        width="800" 
        height="600" 
        style="border:none;">
</iframe>

## まとめ

- `geom_smooth()`でモデルを加えることができる
- `+`でレーヤーを増やす
- `labs`でラベルを整える
- `scale_color_()`でデータの色を整える
- `theme_()`で図の全体の色やフォントなどを整える

# フリータイム